# STEPUP New Code:

# main.py
Determines which computer code is being ran from and imports functions from corresponding directories. Then calls main.

#      main
Determines whether the user would like to run the whole image analysis routine or a specific function. If the user would like to run the whole routine, then ISR, perform_astrometry, and perform_photometry are subsequentially called. If the user would like to perform a specific function, which_analysis is called.

Parameters: verbose

Returns: None

#      which_analysis

Calls whichever function (ISR, perform_astrometry, or perform_photometry) the user would like until they have specified that they would not like to call any more functions.

Parameters: answer, dirtarget, dirdark, target, date, computer

Returns: None
    
# ISR:

#   ISR.py

#       ISR_main:
Calls get_unfiltered_calibimages, get_filtered_calibimages, and instrument_signature_removal.

Paramaters: dirtarget, dirdark, target

Returns: image_filters

#       get_unfiltered_calibimages:
Reads in biases and darks and creates master bias by taking the median of all of the biases. The master dark is created by subtracting the master bias from each dark and scaling based on the exposure time and then taking the median of all of the darks. A mbias.fits and mdark.fits file is written to dirtarget/mcalib.

Paramaters: dirtarget, dirdark

Returns: exptime

#       get_filtered_calibimages:
Creates mbias array by reading in all biases and taking the median. Then appends all image filters to a set to determine how many filters of flats there are. Then reads in flats of each filter, removes the bias, and then divides by the average of the middle region (unaffected by flat fielding) of the flat. The average is then taken to create the master flat and that file is written to dirtarget/mcalib.

Parameters: dirtarget

Returns: image_filters

#       instrument_signature_removal:
For each filter, all mcalib files are read in, saturation is calculated, and raw science images are read in. Then the bias, dark, and flat are removed and the instrument signature removed science image is written to dirtarget/ISR_Images/<filter-name>.

Parameters: dirtarget, target, exptime, image_filters

Returns: None

# Calibration:

#   perform_astrometry.py

#       perform_astrometry:

For each image filter, the imstar command from the WCS Tools software package is called for an instrument signature removed file that has WCS information in its header, generated by astrometry.net. This command generates a new-image.tab file that has the position of a number of stars in the image both in pixel coords and RA and Dec. The WCS information from the astrometry.net file is written to all of the other ISR images and then imwcs is called to correct this information for each indiviudal image.

Parameters: target, dirtarget, filters, verbose

Returns: None

#   perform_photometry.py

#       perform_photometry:
Calls photometry, counts_to_mag, mag_plot and write_file.

Parameters: target, dirtarget, filters, date, coords, comp_ra, comp_dec, comp_mags, vsp_code, cname, check_ra, check_dec, rname, ref_ra, ref_dec, verbose

Returns: None

#       photometry:
For each filter, get_counts is called for the target RA and Dec, then the RA and Dec comparison stars, check star, and reference star. If the aperture sum of any of the comparison stars is a nan or negative value, it is deleted from the comp_aper_sum array and likewise with the check and reference stars. The corresponding comparison magnitudes are also deleted.

Parameters: dirtarget, filters, coords, comp_ra, com_dec, check_ra, check_dec, ref_ra, ref_dec, comp_mags

Returns: aper_sum, final_comp_apers, check_aper_sum, ref_aper_sum, err, date_obs, altitudes, final_comp_mags

#       counts_to_mag:
Scales the target aperture sum, target error, check aperture sum, and reference aperture sum using the aperture sums of teh comparison stars and their known magnitudes. 

Parameters: aper_sum, comp_aper_sums, err, comp_mags, check_aper_sum, ref_aper_sum

Returns: target_mags, target_err, check_mags_f, ref_mags_f

#       mag_plot:
For each filter, the target magnitudes with error are plotted over time in Julian Days as well as the check magnitudes and a PDF of the light curve is saved to dirtarget/ISR_Images/<filter-name>/WCS/accurate_WCS.

Parameters: target_mgas, target_err, date_obs, target, date, filters, dirtarget, check_mags

#       write_file:
Writes text file in AAVSO Extended file format to dirtarget/ISR_Images/<filter-name>/WCS/accurate_WCS for each filter.

Parameters: target_mags, target_err, date_obs, target, vsp_code, dirtarget, filters, altitudes, cname, cmags, rname, rmags

Returns: None

#       get_counts:
Repeated for each RA and Dec in rightascension and declination. For each image in dirtarget/ISR_Images/<filter-name>/WCS/accurate_WCS, aperture_photometry is called for SkyCircularAperture and SkyCircularAnnulus objects centered at specified RA and Dec. Background level is determined and used to calculate source error. Time of observation and altitudes are read in from each header and returned.

Parameters: dirtarget, rightascension, declination, fil

Returns: total_sum, err, date_obs, altitudes
